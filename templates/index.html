<!DOCTYPE html>
<html lang="ko">
    <head>
        <meta charset="UTF-8" />
        <meta name="viewport" content="width=device-width, initial-scale=1.0" />
        <title>Visionix Device WebServer</title>
        <style>
            body {
                font-family: Arial, sans-serif;
                max-width: 800px;
                margin: 0 auto;
                padding: 20px;
            }
            .api-section {
                margin: 20px 0;
                padding: 15px;
                border: 1px solid #ddd;
                border-radius: 5px;
            }
            .indented {
                margin-left: 20px;
            }
            .value-display {
                background-color: #f5f5f5;
                padding: 10px;
                border-radius: 4px;
                margin: 10px 0;
            }
            .value-label {
                font-weight: bold;
                margin-right: 10px;
            }
            .refresh-button {
                background-color: #4caf50;
                color: white;
                padding: 8px 15px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
                margin: 5px 0;
            }
            .refresh-button:hover {
                background-color: #45a049;
            }
            .error {
                color: red;
                margin: 5px 0;
            }
            .input-group {
                margin: 10px 0;
                display: flex;
                align-items: center;
                gap: 10px;
            }
            .input-field {
                padding: 8px;
                border: 1px solid #ddd;
                border-radius: 4px;
            }
            .submit-button {
                background-color: #2196f3;
                color: white;
                padding: 8px 15px;
                border: none;
                border-radius: 4px;
                cursor: pointer;
            }
            .submit-button:hover {
                background-color: #1976d2;
            }
            .success {
                color: green;
                margin: 5px 0;
            }
            .radio-label {
                margin-right: 15px;
                cursor: pointer;
            }
            .radio-label input[type="radio"] {
                margin-right: 5px;
            }
            pre {
                background-color: #f5f5f5;
                padding: 15px;
                border-radius: 4px;
                overflow-x: auto;
                font-family: "Consolas", monospace;
                margin: 10px 0;
            }
            code {
                font-family: "Consolas", monospace;
            }
        </style>
    </head>
    <body>
        <h1>Visionix Device WebServer</h1>

        <div class="api-section">
            <h3>카메라 상태</h3>
            <div class="value-display">
                <span class="value-label">현재 상태:</span>
                <span id="status-value">로딩 중...</span>
            </div>
            <div class="input-group">
                <label class="radio-label">
                    <input type="radio" name="status" value="0" /> 정상
                </label>
                <label class="radio-label">
                    <input type="radio" name="status" value="1" /> 시계멈춤
                </label>
                <label class="radio-label">
                    <input type="radio" name="status" value="2" /> 신호없음
                </label>
                <label class="radio-label">
                    <input type="radio" name="status" value="3" /> 패널손상
                </label>
                <label class="radio-label">
                    <input type="radio" name="status" value="4" /> 기타이상감지
                </label>
                <button class="submit-button" onclick="updateStatus()">
                    상태 업데이트
                </button>
            </div>
            <button class="refresh-button" onclick="refreshStatus()">
                상태 새로고침
            </button>
            <div id="status-error" class="error"></div>
            <div id="status-success" class="success"></div>
        </div>


        <div class="api-section">
            <h3>시스템 메트릭</h3>
            <p>
                전체 시스템 메트릭을 확인하려면
                <a href="/metrics" target="_blank">/metrics</a>를 방문하세요.
            </p>
        </div>



        <script>
            function formatTimestamp(timestamp) {
                if (!timestamp) return "-";
                const date = new Date(timestamp * 1000);
                return date.toLocaleTimeString("ko-KR");
            }

            function clearMessages(prefix) {
                document.getElementById(prefix + "-error").textContent = "";
                document.getElementById(prefix + "-success").textContent = "";
            }

            async function refreshStatus() {
                const statusValue = document.getElementById("status-value");
                try {
                    const response = await fetch("/status");
                    const data = await response.json();
                    statusValue.textContent = data.status;
                    clearMessages("status");
                } catch (error) {
                    document.getElementById("status-error").textContent =
                        "상태를 가져오는 중 오류가 발생했습니다.";
                }
            }


            async function updateStatus() {
                const selectedRadio = document.querySelector(
                    'input[name="status"]:checked'
                );
                if (!selectedRadio) {
                    document.getElementById("status-error").textContent =
                        "상태를 선택하세요.";
                    return;
                }

                try {
                    const response = await fetch("/status", {
                        method: "POST",
                        headers: {
                            "Content-Type": "application/json",
                        },
                        body: JSON.stringify({
                            status: Number(selectedRadio.value),
                        }),
                    });

                    const data = await response.json();

                    if (response.ok) {
                        // 응답 받은 즉시 상태값 업데이트
                        document.getElementById("status-value").textContent =
                            data.status;
                        document.getElementById("status-success").textContent =
                            "상태가 성공적으로 업데이트되었습니다.";
                        // 0.5초 후에 성공 메시지 삭제
                        setTimeout(() => {
                            document.getElementById("status-success").textContent = "";
                        }, 500);
                    } else {
                        document.getElementById("status-error").textContent =
                            data.error || "오류가 발생했습니다.";
                    }
                } catch (error) {
                    document.getElementById("status-error").textContent =
                        "상태 업데이트 중 오류가 발생했습니다.";
                }
            }




            // 페이지 로드 시 초기 데이터 가져오기
            window.onload = function () {
                refreshStatus();
            };
        </script>
    </body>
</html>